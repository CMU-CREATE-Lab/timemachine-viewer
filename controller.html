<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
    <link href="css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css"/>

    <script src="js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script src="js/org/gigapan/hyperwall/fields.js" type="text/javascript"></script>

    <script src="js/jquery/plugins/touchPunch/jquery.ui.touch-punch.js" type="text/javascript"></script>

    <style type="text/css">
      .tourContainer {
        position: relative;
        display: inline-block;
        width: 190px;
        height: 130px;
        padding: 0;
        border: 0;
        margin-top: 2px;
        margin-right: 1px;
        margin-left: 1px;
        list-style-type: none;
        -moz-user-select: none;
        -khtml-user-select: none;
        -webkit-user-select: none;
        -o-user-select: none;
      }
      .tourTxt {
        position: absolute;
        top: 112px;
        width: inherit;
        font-family: Arial, Helvetica, sans-serif;
        color: white;
        font-size: 11px;
        text-align: center;
        background-color: black;
        opacity: 0.6;
        padding-top: 3px;
        padding-bottom: 3px;
        overflow: hidden;
      }
      .toursSlider {
        display: block;
        padding: 0;
        border: 0;
        margin: 0;
        background-color: black;
        height: 134px;
        white-space: nowrap;
        border: 0px;
        overflow-y: hidden;
      }
      .tourImg {
        padding: 0;
        border: 0;
        opacity: 1;
        width: inherit;
        height: inherit;
      }
      #debug {
        color: white;
      }
      body, html {
        padding: 0;
        border: 0;
        margin: 0;
        background: transparent;
      }
    </style>

    <script>
      var controller;
      var singleTapTimeout;
      var doubleTapHoldTimeout;
      var isSingleTap = false;
      var isDoubleTapHold = false;
      var toursSlider;
      var tourContainerWidth;
      var numberOfTours;
      var isMobile = navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i);
      var enableSorting = false;

      var readThumbnailFromServer = function(firstKeyframe) {
        var image_base64;
        switch(firstKeyframe) {
          case "Rondonia":
            image_base64 = "images/controller/Rondonia.png";
            break;
          case "Tucurui Dam":
            image_base64 = "images/controller/Tucurui Dam.png";
            break;
          case "Meander":
            image_base64 = "images/controller/Meander.png";
            break;
          case "Bolivia Evulsing":
            image_base64 = "images/controller/Bolivia Evulsing.png";
            break;
          case "Mouth of Amazon":
            image_base64 = "images/controller/Mouth of Amazon.png";
            break;
          case "South Cape Cod":
            image_base64 = "images/controller/South Cape Cod.png";
            break;
          case "Outer Banks NC":
            image_base64 = "images/controller/Outer Banks NC.png";
            break;
          case "Urmia":
            image_base64 = "images/controller/Urmia.png";
            break;
          case "Aral Sea":
            image_base64 = "images/controller/Aral Sea.png";
            break;
          case "Aral Expansion":
            image_base64 = "images/controller/Aral Expansion.png";
            break;
          case "Saudi Irrigation":
            image_base64 = "images/controller/Saudi Irrigation.png";
            break;
          case "SE Australia Bushfires":
            image_base64 = "images/controller/SE Australia Bushfires.png";
            break;
          case "Pinatubo":
            image_base64 = "images/controller/Pinatubo.png";
            break;
          case "Cherynobyl":
            image_base64 = "images/controller/Cherynobyl.png";
            break;
          case "Mendenhall Glacier":
            image_base64 = "images/controller/Mendenhall Glacier.png";
            break;
          case "Columbia Glacier":
            image_base64 = "images/controller/Columbia Glacier.png";
            break;
          case "Malaspina Glacier":
            image_base64 = "images/controller/Malaspina Glacier.png";
            break;
          case "Shanghai":
            image_base64 = "images/controller/Shanghai.png";
            break;
          case "Pearl River Delta":
            image_base64 = "images/controller/Pearl River Delta.png";
            break;
          case "Dubai":
            image_base64 = "images/controller/Dubai.png";
            break;
          case "DFW":
            image_base64 = "images/controller/DFW.png";
            break;
          case "Rifle, CO":
            image_base64 = "images/controller/Rifle, CO.png";
            break;
          case "PA Fracking":
            image_base64 = "images/controller/PA Fracking.png";
            break;
          case "Mountaintop Removal":
            image_base64 = "images/controller/Mountaintop Removal.png";
            break;
          case "WyomingCoal":
            image_base64 = "images/controller/WyomingCoal.png";
            break;
          case "Tar Sands, Alberta":
            image_base64 = "images/controller/Tar Sands, Alberta.png";
            break;
          case "Alberta Logging":
            image_base64 = "images/controller/Alberta Logging.png";
            break;
          case "Washington Logging":
            image_base64 = "images/controller/Washington Logging.png";
            break;
        }
        return image_base64;
      };

      var createThumbnailSlider = function(toursData) {
        var tours = toursData.items;
        toursSlider = $(".toursSlider");
        numberOfTours = tours.length;
        for (var i = 0; i < numberOfTours; i++) {
          var tourFragment = tours[i].fragment;
          //call the server to decode the tour fragment
          controller.emit("decodeTour", tourFragment);
        }
      };

      var playTour = function() {
        var locationElem = $(this);
        if (locationElem.attr('disabled') == "disabled")
          return;
        locationElem.attr('disabled', 'disabled');
        var tourFragment = locationElem.attr("data-tourFragment");
        if (tourFragment) {
          controller.emit("playTour", tourFragment);
          // Prevent overclicking with a timeout.
          // Would be best to detect when the final action actuallycompletes though.
          setTimeout(function() {
            locationElem.removeAttr('disabled');
          }, 4000);
        }
      };

      var setLocation = function(event) {
        var locationElem = $(event.currentTarget);
        //console.log(locationElem);
        if (locationElem.attr('disabled') == "disabled")
          return;
        locationElem.attr('disabled', 'disabled');
        var centerView = locationElem.attr("data-centerView");
        if (centerView) {
          controller.emit("setLocation", centerView);
          // Set the location of android object
          var viewObj = JSON.parse(centerView);
          var viewForAndroid = viewObj.center.lat + ',' + viewObj.center.lng + ',' + viewObj.zoom;
          androidObject.setMapLocation(viewForAndroid);
          // Prevent overclicking with a timeout.
          // Would be best to detect when the final action actuallycompletes though.
          setTimeout(function() {
            locationElem.removeAttr('disabled');
          }, 4000);
        }
      };

      var createThumbnail = function(tour) {
        // prevent adding repeatedly from multiple masters
        if (toursSlider.children().length >= numberOfTours)
          return;
        tourContainer = $('<div />').attr({
          "class": "tourContainer",
          "data-tourFragment": tour.fragment,
          "data-bounds": JSON.stringify(tour.firstKeyframe.bounds),
          "data-centerView": JSON.stringify(tour.firstKeyframe.centerView),
          "title": tour.title
        });
        var tourImg = $('<img />').attr({
          "class": "tourImg",
          //"src": readThumbnailFromServer(tour.firstKeyframe)
          "src": readThumbnailFromServer(tour.title)
        });
        var tourTxt = $('<div>' + tour.title + '</div>').attr({
          "class": "tourTxt"
        });
        //attach events
        if (isMobile && enableSorting == true) {
          tourContainer.on("touchstart", function(event) {
            clearTimeout(doubleTapHoldTimeout);
            if (!isDoubleTapHold) {
              //is likely to become a single tap
              singleTapTimeout = setTimeout(function() {
                isSingleTap = true;
              }, 100);
            }
          }).on("touchend", function(event) {
            clearTimeout(singleTapTimeout);
            if (isSingleTap) {
              //consume the single tap
              isSingleTap = false;
              setLocation(event);
            }
            if (isDoubleTapHold) {
              //consume the double tap hold
              isDoubleTapHold = false;
              toursSlider.sortable("disable");
            }
          }).on("touchcancel", function(event) {
            clearTimeout(singleTapTimeout);
            isSingleTap = false;
            if (isDoubleTapHold) {
              //consume the double tap hold
              isDoubleTapHold = false;
              toursSlider.sortable("disable");
            }
          }).on("click", function(event) {
            //is likely to be a double tap hold
            isSingleTap = false;
            clearTimeout(singleTapTimeout);
            isDoubleTapHold = true;
            toursSlider.sortable("enable");
            doubleTapHoldTimeout = setTimeout(function() {
              //too late to be a double tap hold
              isDoubleTapHold = false;
              toursSlider.sortable("disable");
            }, 200);
          });
        } else {
          //tourContainer.on("click", playTour);
          tourContainer.on("click", function(event) {
            setLocation(event);
          });
        }
        //append elements
        tourContainer.append(tourImg, tourTxt);
        toursSlider.append(tourContainer);
        if (tourContainerWidth == undefined) {
          tourContainerWidth = tourContainer.width() + 2;
          //this is used for the bug that some browsers do not fill the background while scrolling.
          toursSlider.css("width", numberOfTours * tourContainerWidth);
        }
        if (toursSlider.children().length == numberOfTours) {
          //set tour slider sortable after loading all images
          //the sortable will be broken if we create it before loading all images
          toursSlider.sortable({
            revert: true,
            start: function(event, ui) {
              ui.item.animate({
                "opacity": "0.5"
              }, 500);
            },
            stop: function(event, ui) {
              ui.item.animate({
                "opacity": "1"
              }, 500);
            }
          }).disableSelection();
          if (isMobile)
            toursSlider.sortable("disable").sortable("option", "revert", false);
        }
      };

      var debug = function(txt) {
        $("#debug").text(txt);
      };

      function init() {
        controller = io.connect('/controller');
        //get tour from server
        $.ajax({
          //url: "http://timemachine-hyperwall.appspot.com/createlab/tours.json"
          url: "tours.json"
        }).done(function(toursData) {
          //server calls this function after decoding the tour URL
          controller.on('sync returnTour', function(tour_str) {
            createThumbnail(tour_str);
          });
          createThumbnailSlider(toursData);
        });
      }

      $(init);
    </script>
  </head>
  <body>
    <div class="toursSlider"></div>
    <div id="debug"></div>
  </body>
</html>