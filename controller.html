<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
    <link href="css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css"/>

    <script src="js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script src="js/org/gigapan/hyperwall/fields.js" type="text/javascript"></script>

    <script src="js/jquery/plugins/touchPunch/jquery.ui.touch-punch.js" type="text/javascript"></script>

    <style type="text/css">
      .editor {
        float: left;
        background-color: red;
        width: 190px;
        height: 133px;
      }
      .tourContainer {
        position: relative;
        display: inline-block;
        width: 190px;
        height: 127px;
        padding: 0;
        border: 1px solid black;
        margin-top: 1px;
        list-style-type: none;
        -moz-user-select: none;
        -khtml-user-select: none;
        -webkit-user-select: none;
        -o-user-select: none;
      }
      .tourTxt {
        position: absolute;
        top: 109px;
        width: inherit;
        font-family: Arial, Helvetica, sans-serif;
        color: white;
        font-size: 11px;
        text-align: center;
        background-color: black;
        opacity: 0.6;
        padding-top: 3px;
        padding-bottom: 3px;
        overflow: hidden;
      }
      .toursSlider {
        position: relative;
        padding: 0;
        border: 0;
        margin: 0;
        background-color: black;
        height: 133px;
        white-space: nowrap;
        border: 0px;
        width: inherit;
      }
      .toursSliderContainer {
        overflow-x: scroll;
        overflow-y: hidden;
        height: inherit;
        background-color: black;
      }
      .tourImg {
        padding: 0;
        border: 0;
        opacity: 1;
        width: inherit;
        height: inherit;
      }
      .tourContainerHighlight {
        border: 1px solid #feff91;
        -moz-box-shadow: 0 0 15px #feff91;
        -webkit-box-shadow: 0 0 15px #feff91;
        box-shadow: 0 0 15px #feff91;
        z-index: 1;
      }
      #debug {
        color: white;
      }
      body, html {
        padding: 0;
        border: 0;
        margin: 0;
        background-color: black;
      }
    </style>

    <script>
      var controller;
      var singleTapTimeout;
      var doubleTapHoldTimeout;
      var isSingleTap = false;
      var isDoubleTapHold = false;
      var $toursSlider;
      var tourContainerWidth;
      var numberOfTours;
      var isMobile = navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i);
      var enableSorting = true;
      var mode = "player";

      // Auto mode variables
      var isAutoModeDelayTimeoutRunning = false;
      var screenIdleTimeout;
      var autoModeDelayTimeout;
      var currentLocationIdx = -1;

      // These three values below are stored on the Android tablet, but for debugging purposes on the Desktop
      // we still need default values to pull from. Thus changing these values *will not have an affect* if
      // you are using the tablet. Instead, change the values in the settings menu there on the tablet.
      var doAutoMode = true;
      var screenIdleTime = 90000;
      var autoModeDelayTime = 25000;

      var setAutoModeDelayTime = function(newValue) {
        autoModeDelayTime = newValue;
        resetScreenIdleTimeout();
      };

      var setScreenIdleTime = function(newValue) {
        screenIdleTime = newValue;
        resetScreenIdleTimeout();
      };

      var resetScreenIdleTimeout = function() {
        stopScreenIdleTimeout();
        startScreenIdleTimeout();
      };

      var setDoAutoMode = function(status) {
        if (status == false)
          stopScreenIdleTimeout();
        doAutoMode = status;
        if (status == true)
          startScreenIdleTimeout();
      };

      var triggerAutoModeClick = function() {
        currentLocationIdx++;
        if (currentLocationIdx >= numberOfTours)
          currentLocationIdx = 0;
        $toursSlider.children().eq(currentLocationIdx).trigger("click");
        autoModeDelayTimeout = setTimeout(function() {
          triggerAutoModeClick();
        }, autoModeDelayTime);
      };

      var runAutoMode = function() {
        isAutoModeDelayTimeoutRunning = true;
        try {
          androidObject.setIsAutoModeDelayTimeoutRunning(true);
        } catch(err) {
          console.log("androidObject is undefined for function runAutoMode(). Reference error!");
        }
        triggerAutoModeClick();
      };

      var stopAutoMode = function() {
        isAutoModeDelayTimeoutRunning = false;
        try {
          androidObject.setIsAutoModeDelayTimeoutRunning(false);
        } catch(err) {
          console.log("androidObject is undefined for function stopAutoMode(). Reference error!");
        }
        clearTimeout(autoModeDelayTimeout);
      };

      var startScreenIdleTimeout = function() {
        if (doAutoMode == false)
          return;
        clearTimeout(screenIdleTimeout);
        screenIdleTimeout = setTimeout(function() {
          runAutoMode();
        }, screenIdleTime);
      };

      var stopScreenIdleTimeout = function() {
        if (doAutoMode == false)
          return;
        if (isAutoModeDelayTimeoutRunning)
          stopAutoMode();
        clearTimeout(screenIdleTimeout);
      };

      var createThumbnailSlider = function(tourData) {
        var tourURL = tourData.items[0].fragment;
        $toursSlider = $(".toursSlider");
        //call the server to decode the tour url
        controller.emit("decodeTour", tourURL);
      };

      var setLocation = function(event) {
        var locationElem = $(event.currentTarget);
        if (locationElem.attr('disabled') == "disabled")
          return;
        locationElem.attr('disabled', 'disabled');
        var centerView = locationElem.attr("data-centerView");
        if (centerView) {
          controller.emit("setLocation", centerView);
          // Set the location of android object
          var viewObj = JSON.parse(centerView);
          var viewForAndroid = viewObj.center.lat + ',' + viewObj.center.lng + ',' + viewObj.zoom;
          try {
            androidObject.setMapLocation(viewForAndroid);
          } catch(err) {
            console.log("androidObject is undefined for function setLocation(). Reference error!");
          }
          // Prevent overclicking with a timeout.
          // Would be best to detect when the final action actuallycompletes though.
          setTimeout(function() {
            locationElem.removeAttr('disabled');
          }, 4000);
        }
      };

      var createThumbnail = function(tourJSON) {
        // prevent adding repeatedly from multiple masters
        numberOfTours = tourJSON.keyframes.length;
        if ($toursSlider.children().length >= numberOfTours)
          return;
        for (var i = 0; i < numberOfTours; i++) {
          var keyframe = tourJSON.keyframes[i];
          $tourContainer = $('<div />').attr({
            "class": "tourContainer",
            "data-bounds": JSON.stringify(keyframe.bounds),
            "data-centerView": JSON.stringify(keyframe.centerView)
          });
          var $tourImg = $('<img />').attr({
            "class": "tourImg",
            //"src": readThumbnailFromServer(tour.firstKeyframe)
            "src": keyframe.thumbnailURL
          });
          var $tourTxt = $('<div>' + keyframe.unsafe_string_frameTitle + '</div>').attr({
            "class": "tourTxt"
          });
          //attach events
          if (isMobile && enableSorting == true) {
            $tourContainer.on("touchstart", function(event) {
              clearTimeout(doubleTapHoldTimeout);
              if (!isDoubleTapHold) {
                //is likely to become a single tap
                singleTapTimeout = setTimeout(function() {
                  isSingleTap = true;
                }, 100);
              }
            }).on("touchend", function(event) {
              clearTimeout(singleTapTimeout);
              if (isSingleTap) {
                //consume the single tap
                isSingleTap = false;
                setLocation(event);
                var $currentTarget = $(event.currentTarget);
                currentLocationIdx = $currentTarget.index();
                $toursSlider.children().removeClass("tourContainerHighlight");
                $currentTarget.addClass("tourContainerHighlight");
                // Scroll to the position
                if (isAutoModeDelayTimeoutRunning)
                  $(document).scrollLeft(Math.round($currentTarget.position().left - $(window).width() / 2 + tourContainerWidth / 2));
              }
              if (isDoubleTapHold) {
                //consume the double tap hold
                isDoubleTapHold = false;
                $toursSlider.sortable("disable");
              }
            }).on("touchcancel", function(event) {
              clearTimeout(singleTapTimeout);
              isSingleTap = false;
              if (isDoubleTapHold) {
                //consume the double tap hold
                isDoubleTapHold = false;
                $toursSlider.sortable("disable");
              }
            }).on("click", function(event) {
              //is likely to be a double tap hold
              isSingleTap = false;
              clearTimeout(singleTapTimeout);
              isDoubleTapHold = true;
              $toursSlider.sortable("enable");
              doubleTapHoldTimeout = setTimeout(function() {
                //too late to be a double tap hold
                isDoubleTapHold = false;
                $toursSlider.sortable("disable");
              }, 200);
            });
          } else {
            $tourContainer.on("click", function(event) {
              setLocation(event);
              var $currentTarget = $(event.currentTarget);
              currentLocationIdx = $currentTarget.index();
              $toursSlider.children().removeClass("tourContainerHighlight");
              $currentTarget.addClass("tourContainerHighlight");
              // Scroll to the position
              if (isAutoModeDelayTimeoutRunning)
                $(document).scrollLeft(Math.round($currentTarget.position().left - $(window).width() / 2 + tourContainerWidth / 2));
            });
          }
          //append elements
          $tourContainer.append($tourImg, $tourTxt);
          $toursSlider.append($tourContainer);
          if (tourContainerWidth == undefined) {
            tourContainerWidth = $tourContainer.width() + 2;
            //this is used for the bug that some browsers do not fill the background while scrolling.
            $toursSlider.css("width", numberOfTours * tourContainerWidth);
          }
          if ($toursSlider.children().length == numberOfTours)
            loadingToursComplete();
        }
      };

      var setMode = function(newMode) {
        mode = newMode;
      };

      var loadingToursComplete = function() {
        //set tour slider sortable after loading all images
        //the sortable will be broken if we create it before loading all images
        $toursSlider.sortable({
          axis: "x",
          distance: 30,
          tolerance: "pointer",
          scrollSensitivity: 150,
          scrollSpeed: 50,
          delay: 100,
          revert: true,
          start: function(event, ui) {
            ui.item.animate({
              "opacity": "0.5"
            }, 500);
          },
          stop: function(event, ui) {
            ui.item.animate({
              "opacity": "1"
            }, 500);
          }
        }).disableSelection();
        if (isMobile)
          $toursSlider.sortable("disable").sortable("option", "revert", false);
        // Auto Mode
        startScreenIdleTimeout();
        $toursSlider.on("mousedown touchstart", function() {
          stopScreenIdleTimeout();
        });
        $toursSlider.on("mouseup touchend touchcancel", function() {
          startScreenIdleTimeout();
        });
      };

      var debug = function(txt) {
        $("#debug").text(txt);
      };

      function init() {
        controller = io.connect('/controller');
        //get tour from server
        $.ajax({
          //url: "http://timemachine-hyperwall.appspot.com/createlab/tours.json"
          url: "tour.json"
        }).done(function(tourData) {
          //server calls this function after decoding the tour URL
          controller.on('sync returnTour', function(tour_str) {
            createThumbnail(tour_str);
          });
          controller.on('sync stopScreenIdleTimeout', function() {
            stopScreenIdleTimeout();
          });
          createThumbnailSlider(tourData);
        });
      }

      $(init);
    </script>
  </head>
  <body>
    <!--    <div class="editor"></div>-->
    <div class="toursSliderContainer">
      <div class="toursSlider"></div>
    </div>
    <div id="debug"></div>
  </body>
</html>