<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link href="css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css"/>

    <script src="js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script src="js/org/gigapan/hyperwall/fields.js" type="text/javascript"></script>

    <script src="js/jquery/plugins/touchPunch/jquery.ui.touch-punch.js" type="text/javascript"></script>

    <style type="text/css">
      .noLeftBorder {
        border-left: 0px !important;
      }
      .editor {
        float: left;
        background-color: transparent;
        width: 150px;
        height: 133px;
        border: 0px;
        display: none;
      }
      .add {
        position: absolute;
        top: 2px;
        left: 1px;
        height: 127px;
        width: 147px;
      }
      .ui-button {
        border-radius: 0px !important;
        color: #656565;
        background: white;
        border: 0px;
        font-size: 35px;
        font-family: Arial, Helvetica, sans-serif;
        outline: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        -o-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: rgba(0,0,0,0.5);
      }
      .tourContainer {
        position: relative;
        display: inline-block;
        width: 190px;
        height: 127px;
        padding: 0;
        border: 1px solid black;
        margin-top: 1px;
        list-style-type: none;
        -moz-user-select: none;
        -khtml-user-select: none;
        -webkit-user-select: none;
        -o-user-select: none;
      }
      .tourTxt {
        position: absolute;
        bottom: 0px;
        width: inherit;
        font-family: Arial, Helvetica, sans-serif;
        color: white;
        font-size: 11px;
        text-align: center;
        background-color: black;
        opacity: 0.6;
        padding-top: 3px;
        padding-bottom: 3px;
        overflow: hidden;
      }
      .toursSlider {
        position: relative;
        padding: 0;
        margin: 0;
        background-color: black;
        height: 133px;
        white-space: nowrap;
        border: 0px;
        width: inherit;
      }
      .toursSliderContainer {
        overflow-x: scroll;
        overflow-y: hidden;
        height: inherit;
        background-color: black;
      }
      .tourImg {
        padding: 0;
        border: 0;
        opacity: 1;
        width: inherit;
        height: inherit;
      }
      .tourOverlayHighlight {
        border: 3px solid #feff91 !important;
        -moz-box-shadow: inset 0 0 15px #000;
        -webkit-box-shadow: inset 0 0 15px #000;
        box-shadow: inset 0 0 15px #000;
        z-index: 1;
        -webkit-transition: all 0.2s linear;
        -o-transition: all 0.2s linear;
        -moz-transition: all 0.2s linear;
        -ms-transition: all 0.2s linear;
        transition: all 0.2s linear;
      }
      .tourOverlay {
        position: absolute;
        border: 3px solid transparent;
        width: 184px;
        height: 121px;
        -webkit-transition: all 0.2s linear;
        -o-transition: all 0.2s linear;
        -moz-transition: all 0.2s linear;
        -ms-transition: all 0.2s linear;
        transition: all 0.2s linear;
      }
      #debug {
        color: white;
      }
      body, html {
        padding: 0;
        border: 0;
        margin: 0;
        background-color: black;
      }
    </style>

    <script>
      var controller;
      var singleTapTimeout;
      var doubleTapHoldTimeout;
      var isSingleTap = false;
      var isDoubleTapHold = false;
      var $toursSliderContainer;
      var $toursSlider;
      var $editor;
      var tourContainerWidth;
      var isMobile = navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i);
      var enableSorting = false;
      var mode = "player";
      var tourJSON;

      // Auto mode variables
      var isAutoModeDelayTimeoutRunning = false;
      var screenIdleTimeout;
      var autoModeDelayTimeout;
      var currentLocationIdx = -1;

      // These three values below are stored on the Android tablet, but for debugging purposes on the Desktop
      // we still need default values to pull from. Thus changing these values *will not have an affect* if
      // you are using the tablet. Instead, change the values in the settings menu there on the tablet.
      var doAutoMode = true;
      var screenIdleTime = 90000;
      var autoModeDelayTime = 25000;

      var setAutoModeDelayTime = function(newValue) {
        autoModeDelayTime = newValue;
        resetScreenIdleTimeout();
      };

      var setScreenIdleTime = function(newValue) {
        screenIdleTime = newValue;
        resetScreenIdleTimeout();
      };

      var resetScreenIdleTimeout = function() {
        stopScreenIdleTimeout();
        startScreenIdleTimeout();
      };

      var setDoAutoMode = function(status) {
        if (status == false)
          stopScreenIdleTimeout();
        doAutoMode = status;
        if (status == true)
          startScreenIdleTimeout();
      };

      var triggerAutoModeClick = function() {
        currentLocationIdx++;
        if (currentLocationIdx >= tourJSON.keyframes.length)
          currentLocationIdx = 0;
        $toursSlider.children().eq(currentLocationIdx).trigger("click");
        autoModeDelayTimeout = setTimeout(function() {
          triggerAutoModeClick();
        }, autoModeDelayTime);
      };

      var runAutoMode = function() {
        isAutoModeDelayTimeoutRunning = true;
        try {
          androidObject.setIsAutoModeDelayTimeoutRunning(true);
        } catch(err) {
          console.log("androidObject is undefined for function runAutoMode(). Reference error!");
        }
        triggerAutoModeClick();
      };

      var stopAutoMode = function() {
        isAutoModeDelayTimeoutRunning = false;
        try {
          androidObject.setIsAutoModeDelayTimeoutRunning(false);
        } catch(err) {
          console.log("androidObject is undefined for function stopAutoMode(). Reference error!");
        }
        clearTimeout(autoModeDelayTimeout);
      };

      var startScreenIdleTimeout = function() {
        if (doAutoMode == false)
          return;
        clearTimeout(screenIdleTimeout);
        screenIdleTimeout = setTimeout(function() {
          runAutoMode();
        }, screenIdleTime);
      };

      var stopScreenIdleTimeout = function() {
        if (doAutoMode == false)
          return;
        if (isAutoModeDelayTimeoutRunning)
          stopAutoMode();
        clearTimeout(screenIdleTimeout);
      };

      var createThumbnailSlider = function(tourData) {
        var encodedTour = tourData.items[0].fragment;
        $toursSlider = $(".toursSlider");
        $toursSliderContainer = $(".toursSliderContainer");
        // Call the server to decode the tour url
        controller.emit("decodeTour", encodedTour);
      };

      var setLocation = function(event) {
        var locationElem = $(event.currentTarget);
        if (locationElem.attr('disabled') == "disabled")
          return;
        locationElem.attr('disabled', 'disabled');
        var centerView = locationElem.attr("data-centerView");
        if (centerView) {
          controller.emit("setLocation", centerView);
          // Set the location of android object
          var viewObj = JSON.parse(centerView);
          var viewForAndroid = viewObj.center.lat + ',' + viewObj.center.lng + ',' + viewObj.zoom;
          try {
            androidObject.setMapLocation(viewForAndroid);
          } catch(err) {
            console.log("androidObject is undefined for function setLocation(). Reference error!");
          }
          // Prevent overclicking with a timeout.
          // Would be best to detect when the final action actuallycompletes though.
          setTimeout(function() {
            locationElem.removeAttr('disabled');
          }, 4000);
        }
      };

      var addThumbnail = function(keyframe) {
        var $tourContainer = $('<div />').attr({
          "class": "tourContainer",
          "data-bounds": JSON.stringify(keyframe.bounds),
          "data-centerView": JSON.stringify(keyframe.centerView)
        });
        var $tourImg = $('<img />').attr({
          "class": "tourImg",
          "src": keyframe.thumbnailURL
        });
        var $tourTxt = $('<div>' + keyframe.unsafe_string_frameTitle + '</div>').attr({
          "class": "tourTxt"
        });
        var $tourOverlay = $('<div class="tourOverlay"></div>');
        // Attach events
        if (isMobile && enableSorting == true) {
          $tourContainer.on("touchstart", function(event) {
            clearTimeout(doubleTapHoldTimeout);
            if (!isDoubleTapHold) {
              // Is likely to become a single tap
              singleTapTimeout = setTimeout(function() {
                isSingleTap = true;
              }, 100);
            }
          }).on("touchend", function(event) {
            clearTimeout(singleTapTimeout);
            if (isSingleTap) {
              // Consume the single tap
              isSingleTap = false;
              setLocation(event);
              var $currentTarget = $(event.currentTarget);
              currentLocationIdx = $currentTarget.index();
              $toursSlider.children().children(".tourOverlay").removeClass("tourOverlayHighlight");
              $currentTarget.children(".tourOverlay").addClass("tourOverlayHighlight");
              // Scroll to the position
              if (isAutoModeDelayTimeoutRunning)
                $(document).scrollLeft(Math.round($currentTarget.position().left - $(window).width() / 2 + tourContainerWidth / 2));
            }
            if (isDoubleTapHold) {
              // Consume the double tap hold
              isDoubleTapHold = false;
              $toursSlider.sortable("disable");
            }
          }).on("touchcancel", function(event) {
            clearTimeout(singleTapTimeout);
            isSingleTap = false;
            if (isDoubleTapHold) {
              // Consume the double tap hold
              isDoubleTapHold = false;
              $toursSlider.sortable("disable");
            }
          }).on("click", function(event) {
            // Is likely to be a double tap hold
            isSingleTap = false;
            clearTimeout(singleTapTimeout);
            isDoubleTapHold = true;
            $toursSlider.sortable("enable");
            doubleTapHoldTimeout = setTimeout(function() {
              // Too late to be a double tap hold
              isDoubleTapHold = false;
              $toursSlider.sortable("disable");
            }, 200);
          });
        } else {
          $tourContainer.on("click", function(event) {
            setLocation(event);
            var $currentTarget = $(event.currentTarget);
            currentLocationIdx = $currentTarget.index();
            $toursSlider.children().children(".tourOverlay").removeClass("tourOverlayHighlight");
            $currentTarget.children(".tourOverlay").addClass("tourOverlayHighlight");
            // Scroll to the position
            var containerOffset = $toursSliderContainer.offset();
            var containerWidth = $toursSliderContainer.width();
            var elementOffset = $currentTarget.offset();
            var elementWidth = $currentTarget.width();
            var distanceBetweenElementAndLeftEdge = elementOffset.left + elementWidth - containerOffset.left;
            var distanceBetweenElementAndRightEdge = containerWidth - elementOffset.left + containerOffset.left;
            if (distanceBetweenElementAndRightEdge < elementWidth * 1.5) {
              $toursSliderContainer.animate({
                scrollLeft: $toursSliderContainer.scrollLeft() + (elementWidth * 1.5 - distanceBetweenElementAndRightEdge)
              }, 200);
            } else if (distanceBetweenElementAndLeftEdge < elementWidth * 1.5) {
              $toursSliderContainer.animate({
                scrollLeft: $toursSliderContainer.scrollLeft() - (elementWidth * 1.5 - distanceBetweenElementAndLeftEdge)
              }, 200);
            }
          });
        }// Append elements
        $tourContainer.append($tourOverlay, $tourImg, $tourTxt);
        $toursSlider.append($tourContainer);
        if (tourContainerWidth == undefined) {
          tourContainerWidth = $tourContainer.width() + 2;
          // This is used for the bug that some browsers do not fill the background while scrolling.
          $toursSlider.css("width", tourJSON.keyframes.length * tourContainerWidth);
        }
      };

      var createThumbnails = function() {
        // Prevent adding repeatedly from multiple masters
        if ($toursSlider.children().length >= tourJSON.keyframes.length)
          return;
        for (var i = 0; i < tourJSON.keyframes.length; i++)
          addThumbnail(tourJSON.keyframes[i]);
        loadingComplete();
      };

      var setMode = function(newMode) {
        mode = newMode;
        refreshSlider();
        if (mode == "player")
          $editor.hide();
        else if (mode == "editor")
          $editor.show();
      };

      var refreshSlider = function() {
        $($toursSlider.children()).removeClass("noLeftBorder");
        if (mode == "editor")
          $($toursSlider.children().get(0)).addClass("noLeftBorder");
      };

      var createEditorControl = function() {
        $editor = $(".editor");
        $(".add").button().click(function() {
          var title = "Custom Title";
          controller.emit("recordKeyframe", title);
        });
      };

      var loadingComplete = function() {
        // Set tour slider sortable after loading all images
        // The sortable will be broken if we create it before loading all images
        $toursSlider.sortable({
          axis: "x",
          distance: 30,
          tolerance: "pointer",
          scrollSensitivity: 150,
          scrollSpeed: 50,
          delay: 100,
          revert: true,
          start: function(event, ui) {
            ui.item.animate({
              "opacity": "0.5"
            }, 500);
          },
          stop: function(event, ui) {
            ui.item.animate({
              "opacity": "1"
            }, 500);
          }
        }).disableSelection();
        if (isMobile)
          $toursSlider.sortable("disable").sortable("option", "revert", false);
        // Auto Mode
        startScreenIdleTimeout();
        $toursSlider.on("mousedown touchstart", function() {
          stopScreenIdleTimeout();
        });
        $toursSlider.on("mouseup touchend touchcancel", function() {
          startScreenIdleTimeout();
        });
        // TODO: move this code to Android for toggling
        //setMode("editor");
      };

      var debug = function(txt) {
        $("#debug").text(txt);
      };

      function init() {
        controller = io.connect('/controller');
        // Get tour from server
        $.ajax({
          //url: "http://timemachine-hyperwall.appspot.com/createlab/tours.json"
          url: "tour.json"
        }).done(function(tourData) {
          // Server calls this function after decoding the tour URL
          controller.on('sync returnTour', function(data) {
            tourJSON = data;
            if ($toursSlider.children().length == 0)
              createThumbnails();
          });
          controller.on('sync returnKeyframe', function(keyframe) {
            addThumbnail(keyframe);
          });
          controller.on('sync stopScreenIdleTimeout', function() {
            stopScreenIdleTimeout();
          });
          createThumbnailSlider(tourData);
          createEditorControl();
        });
      }

      // Unused
      function createTour() {
        $.ajax({
          url: "https://timemachine-hyperwall.appspot.com/tour",
          type: "POST",
          data: {
            fragment: "Hey Paul"
          }
        }).done(function(data) {
          console.log(data);
        });
      }

      // Unused
      function init_() {
        controller = io.connect('/controller');
        $.ajax({
          url: "https://timemachine-hyperwall.appspot.com/login",
          type: "POST",
          data: {
            sitename: "createlab",
            password: "f0b5d537"
          }
        }).done(function(data) {
          console.log(data);
          createTour();
        });
      }

      $(init);
    </script>
  </head>
  <body>
    <div class="editor">
      <button type="button" class="add">+</button>
    </div>
    <div class="toursSliderContainer">
      <div class="toursSlider"></div>
    </div>
    <div id="debug"></div>
  </body>
</html>