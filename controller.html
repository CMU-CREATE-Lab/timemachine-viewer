<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
    <link href="css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css"/>

    <script src="js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script src="js/org/gigapan/hyperwall/fields.js" type="text/javascript"></script>

    <script src="js/jquery/plugins/touchPunch/jquery.ui.touch-punch.js" type="text/javascript"></script>

    <style type="text/css">
      .tourContainer {
        position: relative;
        display: inline-block;
        width: 190px;
        height: 130px;
        padding: 0;
        border: 0;
        margin-top: 2px;
        margin-right: 1px;
        margin-left: 1px;
        list-style-type: none;
        -moz-user-select: none;
        -khtml-user-select: none;
        -webkit-user-select: none;
        -o-user-select: none;
      }
      .tourTxt {
        position: absolute;
        top: 112px;
        width: inherit;
        font-family: Arial, Helvetica, sans-serif;
        color: white;
        font-size: 11px;
        text-align: center;
        background-color: black;
        opacity: 0.6;
        padding-top: 3px;
        padding-bottom: 3px;
        overflow: hidden;
      }
      .toursSlider {
        display: block;
        padding: 0;
        border: 0;
        margin: 0;
        background-color: black;
        height: 134px;
        white-space: nowrap;
        border: 0px;
        overflow-y: hidden;
      }
      .tourImg {
        padding: 0;
        border: 0;
        opacity: 1;
        width: inherit;
        height: inherit;
      }
      .tourImg:hover {
        opacity: 1;
      }
      body, html {
        padding: 0;
        border: 0;
        margin: 0;
        background: transparent;
      }
    </style>

    <script>
      var controller;
      var enableSortableTimeout;
      var enableSortable = true;
      var toursSlider;
      var tourContainerWidth;
      var numberOfTours;
      var isMobile = navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i);

      var readThumbnailFromServer = function(firstKeyframe) {
        var image_base64;
        switch(firstKeyframe) {
          case "Growth of Las Vegas, Nevada":
            image_base64 = "images/controller/vegas.png";
            break;
          case "Amazon Deforestation, Brazil":
            image_base64 = "images/controller/brazil.png";
            break;
          case "Wyoming Coal Mining":
            image_base64 = "images/controller/wyoming.png";
            break;
          case "Columbia Glacier Retreat":
            image_base64 = "images/controller/glacier.png";
            break;
          case "Saudi Arabia Irrigation":
            image_base64 = "images/controller/saudi.png";
            break;
          case "Dubai Coastal Expansion":
            image_base64 = "images/controller/dubai.png";
            break;
          case "Drying of Lake Urmia, Iran":
            image_base64 = "images/controller/urmia.png";
            break;
          case "Drying of the Aral Sea":
            image_base64 = "images/controller/aral.png";
            break;
        }
        return image_base64;
      };

      var createThumbnailSlider = function(toursData) {
        var tours = toursData.items;
        toursSlider = $(".toursSlider");
        numberOfTours = tours.length;
        for (var i = 0; i < numberOfTours; i++) {
          var tourFragment = tours[i].fragment;
          //call the server to decode the tour fragment
          controller.emit("decodeTour", tourFragment);
        }
      };

      var playTour = function() {
        var locationElem = $(this);
        if (locationElem.attr('disabled') == "disabled")
          return;
        locationElem.attr('disabled', 'disabled');
        var tourFragment = locationElem.attr("data-tourFragment");
        if (tourFragment) {
          controller.emit("playTour", tourFragment);
          // Prevent overclicking with a timeout.
          // Would be best to detect when the final action actuallycompletes though.
          setTimeout(function() {
            locationElem.removeAttr('disabled');
          }, 4000);
        }
      };

      var setLocation = function() {
        var locationElem = $(this);
        if (locationElem.attr('disabled') == "disabled")
          return;
        locationElem.attr('disabled', 'disabled');
        var centerView = locationElem.attr("data-centerView");
        if (centerView) {
          controller.emit("setLocation", centerView);
          // Set the location of android object
          var viewObj = JSON.parse(centerView);
          var viewForAndroid = viewObj.center.lat + ',' + viewObj.center.lng + ',' + viewObj.zoom;
          androidObject.setMapLocation(viewForAndroid);
          // Prevent overclicking with a timeout.
          // Would be best to detect when the final action actuallycompletes though.
          setTimeout(function() {
            locationElem.removeAttr('disabled');
          }, 4000);
        }
      };

      var createThumbnail = function(tour) {
        // prevent adding repeatedly from multiple masters
        if (toursSlider.children().length >= numberOfTours)
          return;
        tourContainer = $('<div />').attr({
          "class": "tourContainer",
          "data-tourFragment": tour.fragment,
          "data-bounds": JSON.stringify(tour.firstKeyframe.bounds),
          "data-centerView": JSON.stringify(tour.firstKeyframe.centerView),
          "title": tour.title
        });
        var tourImg = $('<img />').attr({
          "class": "tourImg",
          //"src": readThumbnailFromServer(tour.firstKeyframe)
          "src": readThumbnailFromServer(tour.title)
        });
        var tourTxt = $('<div>' + tour.title + '</div>').attr({
          "class": "tourTxt"
        });
        //attach events
        //tourContainer.on("click", playTour);
        tourContainer.on("click", setLocation);
        if (isMobile) {
          tourContainer.on("touchstart", function(event) {
            enableSortableTimeout = setTimeout(function() {
              enableSortable = false;
            }, 100);
          }).on("touchend", function(event) {
            clearTimeout(enableSortableTimeout);
            if (enableSortable) {
              toursSlider.sortable("enable");
            } else {
              enableSortable = true;
              toursSlider.sortable("disable");
            }
          }).on("click", function(event) {
            toursSlider.sortable("disable");
          });
        }
        //append elements
        tourContainer.append(tourImg, tourTxt);
        toursSlider.append(tourContainer);
        if (tourContainerWidth == undefined) {
          tourContainerWidth = tourContainer.width() + 2;
          //this is used for the bug that some browsers do not fill the background while scrolling.
          toursSlider.css("width", numberOfTours * tourContainerWidth);
        }
        if (toursSlider.children().length == numberOfTours) {
          //set tour slider sortable after loading all images
          //the sortable will be broken if we create it before loading all images
          toursSlider.sortable({
            revert: true,
            start: function(event, ui) {
              ui.item.animate({
                "opacity": "0.5"
              }, 500);
            },
            stop: function(event, ui) {
              ui.item.animate({
                "opacity": "1"
              }, 500);
            }
          }).disableSelection();
          if (isMobile)
            toursSlider.sortable("disable").sortable("option", "revert", false);
        }
      };

      var debug = function(txt) {
        $("#debug").text(txt);
      };

      function init() {
        controller = io.connect('/controller');
        //get tour from server
        $.ajax({
          url: "http://timemachine-hyperwall.appspot.com/createlab/tours.json"
          //url: "tours.json"
        }).done(function(toursData) {
          //server calls this function after decoding the tour URL
          controller.on('sync returnTour', function(tour_str) {
            createThumbnail(tour_str);
          });
          createThumbnailSlider(toursData);
        });
      }

      $(init);
    </script>
  </head>
  <body>
    <div class="toursSlider"></div>
    <div id="debug"></div>
  </body>
</html>