<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>Time Machine In Google Maps - V1</title>
    <link href="timelapse/css/timelapse.css" rel="stylesheet" type="text/css"/>
    <link href="timelapse/css/videoset_stats.css" rel="stylesheet" type="text/css"/>
    <link href="timelapse/css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css"/>
    <link href="timelapse/css/ui.slider.extras.css" rel="stylesheet" type="text/css"/>
    <link href="timelapse/css/player.css" rel="stylesheet" type="text/css"/>
    <link href="http://code.google.com/apis/maps/documentation/javascript/examples/default.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="timelapse/js/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="timelapse/js/jquery/jquery-ui.custom.min.js"></script>
    <script type="text/javascript" src="timelapse/js/jquery/plugins/slider/selectToUISlider.jQuery.js"></script>
    <script type="text/javascript" src="timelapse/js/org/gigapan/util.js"></script>
    <script type="text/javascript" src="timelapse/js/org/gigapan/timelapse/videoset_stats.js"></script>
    <script type="text/javascript" src="timelapse/js/org/gigapan/timelapse/videoset.js"></script>
    <script type="text/javascript" src="timelapse/js/org/gigapan/timelapse/timelapse.js"></script>
    <script type="text/javascript">
      var timelapseLayer;
      var eeMapType;
      var timelapseLayerZIndex;
      var map;
      var currentZoomLevel;
      var timelapseMetadata;
      var timelapseMetadataJSON;
      var gigapanId;
      var datasetIndex;
      var gigapanDatasetsJSON = null;
      var playerLayer = 0;
      var playerSize = 1;
      var captureTimes = new Array();
      var hasLayers = false;
      var timelapseDurationInSeconds = 0.0;
      var timeStepInSecs = 0.0;
      var timelapseCurrentTimeInSeconds = 0.0;
      var timelapse = null;
      var timelapseCurrentCaptureTimeIndex = 0;
      var repeatVideo = false;
      org.gigapan.timelapse.VideosetStats.isEnabled = false;
      var snaplapse = null;
      var timelapseStayOn = false;
      var timelapseControlUI;

      TimelapseOverlay.prototype = new google.maps.OverlayView();
      google.maps.event.addDomListener(window, 'load', initialize);

      function TimelapseToggle(controlDiv, map) {

        // Setting padding to 5 px will offset the control
        // from the edge of the map.
        controlDiv.style.padding = '5px';

        // Set CSS for the control border.
        timelapseControlUI = document.createElement('DIV');
        timelapseControlUI.style.backgroundColor = 'white';
        timelapseControlUI.style.borderStyle = 'solid';
        timelapseControlUI.style.borderWidth = '1px';
        timelapseControlUI.style.cursor = 'pointer';
        timelapseControlUI.style.textAlign = 'center';
        timelapseControlUI.style.width = "120px"
        timelapseControlUI.title = 'Click to toggle Time Machine on/off';
        controlDiv.appendChild(timelapseControlUI);

        // Set CSS for the control interior.
        var controlText = document.createElement('DIV');
        controlText.style.fontFamily = 'Arial,sans-serif';
        controlText.style.fontSize = '16px';
        controlText.style.paddingLeft = '4px';
        controlText.style.paddingRight = '4px';
        controlText.innerHTML = 'Time Machine';
        timelapseControlUI.appendChild(controlText);

        // Setup the click event listeners: simply set the map to Chicago.
        google.maps.event.addDomListener(timelapseControlUI, 'click', function() {
          timelapseStayOn = !timelapseStayOn;
          if (timelapseStayOn) {
            timelapseLayer.show();
          } else {
            timelapseLayer.hide();
          }
          console.log(timelapseStayOn);
        });
      }

      // Initalize the map object. First run when the page loads
      function initialize() {
        var latLng = new google.maps.LatLng(34, -98);
        var mapOptions = {
          zoom: 3,
          center: latLng,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        }

        var eeOptions = {
          getTileUrl: function(coord, zoom) {
            url = "http://earthengine.googleapis.com/map/"+gigapanDatasetsJSON["earthengine-mapids"][0]["mapid"]+"/"+zoom+"/"+coord.x+"/"+coord.y+"?token="+gigapanDatasetsJSON["earthengine-mapids"][0]["token"]
            return url;
          },
          tileSize: new google.maps.Size(256, 256),
          mapTypeId: "ee"
        };

        map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
				eeMapType = new google.maps.ImageMapType(eeOptions);

        var newHeight = ((parseInt(jQuery("#map_canvas").css("height"))-64));
        $("#map_canvas").css({"height":newHeight});

				timelapseInitialize();

        timelapseLayer = new TimelapseOverlay(map);

        map.overlayMapTypes.insertAt(0, eeMapType);

        // Create the DIV to hold the timelapse toggle control
        var timelapseToggleDiv = document.createElement('DIV');
        var timelapseToggle = new TimelapseToggle(timelapseToggleDiv, map);

        timelapseToggleDiv.index = 1;
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(timelapseToggleDiv);

        google.maps.event.addListener(map, 'center_changed', function() {
          console.log("center_changed...");
          timelapseLayer.draw();
        });

        google.maps.event.addListenerOnce(map, 'idle', function(){
          console.log("base tiles fully loaded");
          //timelapseLayer.hide();
          timelapseLayer.draw(); //call draw one more time to be sure everything is in sync
        });

      }

      // Constructor for our timelapseLayer
      function TimelapseOverlay(map, bounds) {
        // Now initialize all properties.
        this.map_ = map;
        //this.bounds_ = bounds;

        // Define a property to hold the time
        // div. We'll actually create this div
        // upon receipt of the add() method so we'll
        // leave it null for now.
        this.div_ = null;

        // Explicitly call setMap on this timelapseLayer
        this.setMap(map);
      }

      // Add the timelapseLayer ontop of the current layer
      TimelapseOverlay.prototype.onAdd = function() {
        // Note: a timelapseLayer's receipt of add() indicates that
        // the map's panes are now available for attaching
        // the timelapseLayer to the map via the DOM.

        // Create the DIV and set some basic attributes.
        var div = document.createElement('DIV');
        div.style.position = "absolute";
        div.style.left = 0 + 'px';
        div.style.top = 0 + 'px';
        div.id = "timelapseLayer"
        //div.style.background = "#000"
        //div.style.width = 100 + "px";
        //div.style.height = 100 + "px";

        // Set the timelapseLayer's div_ property to this DIV
        this.div_ = div;

        // We add a timelapseLayer to a map via one of the map's panes.
        var panes = this.getPanes();
        panes.overlayMouseTarget.appendChild(this.div_);

				timelapseLayerZIndex = jQuery("#timelapseLayer").parent().css("z-index")

        this.hide();
				//jQuery("#timelapseLayer").parent().parent().children().last().css("z-index",99999);
				//console.log(jQuery("#timelapseLayer").parent().next().next().next());

        $("#timelapseLayer").append($("#player"));
        $("#player").css({"visibility": "inherit"});
        console.log("onAdd");
      }

      TimelapseOverlay.prototype.draw = function() {
        console.log("drawing...");

        var projection = this.getProjection();
        var lat = map.getCenter().lat();
        var lng = map.getCenter().lng();
        //console.log("lat: " + lat + " lng: " + lng);
        latlng = new google.maps.LatLng(lat,lng, false);
        var containerCenter = projection.fromLatLngToContainerPixel(latlng);
        //console.log("containerCenter: " + containerCenter);
        var point = new google.maps.Point(Math.ceil(containerCenter.x) - 409, Math.ceil(containerCenter.y) - 0);
        var southWestLatLng = projection.fromContainerPixelToLatLng(point);
        point = new google.maps.Point(Math.ceil(containerCenter.x) + 0, Math.ceil(containerCenter.y) - 235);
        var northEastLatLng = projection.fromContainerPixelToLatLng(point);
        //console.log("southWestLatLng: " + southWestLatLng);
        //console.log("northEastLatLng: " + northEastLatLng);

        // Retrieve the southwest and northeast coordinates of this timelapseLayer
        // in latlngs and convert them to pixels coordinates.
        // We'll use these coordinates to resize the DIV.
        var sw = projection.fromLatLngToDivPixel(southWestLatLng);
        var ne = projection.fromLatLngToDivPixel(northEastLatLng);

        // Resize the image's DIV to fit the indicated dimensions.
        var div = this.div_;

        div.style.left = sw.x + 'px';
        div.style.top = ne.y + 'px';
        //div.style.width = 0 + 'px';
        //div.style.height = 0 + 'px';


				if (timelapse == null) return;

        point = new google.maps.Point($("#map_canvas").width()*0.5, $("#map_canvas").height()*0.5);
        var centerLatLng = projection.fromContainerPixelToLatLng(point);

        console.log("centerLatLng: " + centerLatLng);

        var minLon = -179.99999999999997;
        var maxLon = 179.99999999999997;
        var minLat = -85.05112877980659;
        var maxLat = 85.05112877980659;

        var centerPixel = map.getProjection().fromLatLngToPoint(centerLatLng);
        x = (centerPixel.x / 256.0) * timelapse.getWidth();
        y = (centerPixel.y / 256.0) * timelapse.getHeight();

//        x = (centerLatLng.lng() - minLon) / (maxLon-minLon) * timelapse.getWidth();
//        y = (maxLat - centerLatLng.lat()) / (maxLat-minLat) * timelapse.getHeight();
        scale = projection.getWorldWidth() / timelapse.getWidth() * (maxLon-minLon) / 360;

        console.log("x: " + x + " y: " + y + " scale: " + scale);

        timelapse.warpTo({x: x, y: y, scale: scale});
      }

      TimelapseOverlay.prototype.onRemove = function() {
        this.div_.parentNode.removeChild(this.div_);
      }

      TimelapseOverlay.prototype.hide = function() {
        if (timelapseStayOn) return;

        if (this.div_) {
          this.div_.style.visibility = "hidden";
          timelapseControlUI.style.fontWeight = "normal"
        }
      }

      TimelapseOverlay.prototype.show = function() {
        if (this.div_) {
          this.div_.style.visibility = "visible";
          timelapseControlUI.style.fontWeight = "bold"
        }
      }

      TimelapseOverlay.prototype.toggle = function() {
        if (this.div_) {
          if (this.div_.style.visibility == "hidden") {
            this.show();
          } else {
            this.hide();
          }
        }
      }

      TimelapseOverlay.prototype.toggleDOM = function() {
        if (this.getMap()) {
          this.setMap(null);
        } else {
          this.setMap(this.map_);
        }
      }

      function hideEeLayer() {
        //eeMapType.setMap(null);
        timelapseLayer.show();
        if (map.overlayMapTypes.getLength() > 0) map.overlayMapTypes.removeAt(0);
        //jQuery("#timelapseLayer").parent().css("z-index",timelapseLayerZIndex); //timelapse overlay container
        //jQuery("#timelapseLayer").parent().parent().children().last().css("z-index",1) //tiles container
        //jQuery("#timelapseLayer").parent().parent().children().last().css("z-index",0);
      }

      function showTimelapseLayer() {
        //eeMapType.setMap(map);
        timelapseLayer.hide();
        map.overlayMapTypes.insertAt(0, eeMapType);
        //jQuery("#timelapseLayer").parent().css("z-index",0);
        //jQuery("#timelapseLayer").parent().parent().children().last().css("z-index",99999);
      }

			function createTimelineSlider() {
				if (gigapanDatasetsJSON["capture-times"]) {
					captureTimes = gigapanDatasetsJSON["capture-times"];
				} else {
					for (i = 0; i < timelapse.getNumFrames(); i++) {
						captureTimes.push("--")
					}
				}

				timelapseDurationInSeconds = (timelapse.getNumFrames() -1 ) / timelapse.getFps();
				timeStepInSecs = 1 / timelapse.getFps();
				$("#currentTime").text(org.gigapan.Util.formatTime(timelapseCurrentTimeInSeconds,true));
				$("#totalTime").text(org.gigapan.Util.formatTime(timelapseDurationInSeconds,true));
				$("#currentCaptureTime").text(captureTimes[timelapseCurrentCaptureTimeIndex]);

				$("#timelineSlider")["slider"]({
					animate: true,
					value: 0,
					min: 0.0,
					max: timelapseDurationInSeconds,
					range: "min",
					step: timeStepInSecs,
					slide: function(e, ui) {
						timelapse.seek(ui.value);
						timelapseLayer.show();
						hideEeLayer();
					},
					stop: function() {
					  //showTimelapseLayer();
					  changeEeLayer();
					}
				});

				$("#timelineSlider .ui-slider-handle").attr("title", "Drag to go to a different point in time");
			}


      function changeEeLayer() {
        //showTimelapseLayer();
        if (map.overlayMapTypes.getLength() > 0) map.overlayMapTypes.removeAt(0);
        eeOptions = {
          getTileUrl: function(coord, zoom) {
            url = "http://earthengine.googleapis.com/map/"+gigapanDatasetsJSON["earthengine-mapids"][timelapseCurrentCaptureTimeIndex]["mapid"]+"/"+zoom+"/"+coord.x+"/"+coord.y+"?token="+gigapanDatasetsJSON["earthengine-mapids"][timelapseCurrentCaptureTimeIndex]["token"]
            return url;
          },
          tileSize: new google.maps.Size(256, 256),
          mapTypeId: "ee"
        };
        eeMapType = new google.maps.ImageMapType(eeOptions);
        map.overlayMapTypes.insertAt(0, eeMapType);
      }

			function createPlaybackSpeedSlider() {
				$("#speed").selectToUISlider({
					labels: 4
				}).hide();
			}

			function loadTimelapse(gigapanUrl, gigapanJSON) {
				$("#timelapse").empty();

				// Create the timelapse
				if (timelapse == null) {
					timelapse = new org.gigapan.timelapse.Timelapse(gigapanUrl, "timelapse", gigapanJSON, "videoset_stats_container");

					timelapse.addTimeChangeListener(function(t) {
						timelapseCurrentTimeInSeconds = t;
						timelapseCurrentCaptureTimeIndex = Math.floor(t * timelapse.getFps());

						if (timelapseCurrentTimeInSeconds.toFixed(3) < 0) {
							timelapseCurrentTimeInSeconds = 0;
							timelapse.pause();
							$("#mainbutton").attr({"class": "play", "title": "Play"});
							changeEeLayer();
						}

						if (isCurrentTimeAtOrPastDuration()) {
							timelapseCurrentTimeInSeconds = timelapseDurationInSeconds;
							if (repeatVideo) {
								timelapse.seek(0);
							} else {
								timelapse.pause();
								$("#mainbutton").attr({"class": "play", "title": "Play"});
								changeEeLayer();
							}
						}
						$("#currentTime").text(org.gigapan.Util.formatTime(timelapseCurrentTimeInSeconds,true));
						$("#currentCaptureTime").text(captureTimes[timelapseCurrentCaptureTimeIndex]);
						$("#timelineSlider")["slider"]("option", "value", timelapseCurrentTimeInSeconds);
					});

					timelapse.addTargetViewChangeListener(function(view) {
						$("#zoomSlider")["slider"]("option", "value", timelapse.viewScaleToZoomSlider(view.scale));
					});

					timelapse.getVideoset().addEventListener("videoset-pause", function() {
						// the videoset might cause playback to pause, such as when it decides
						// its hit the end (even though the current time might not be >= duration),
						// so we need to make sure the play button is updated
						$("#mainbutton").attr({"class": "play", "title": "Play"});
					});

					//setupKeyboardHandlers();
					//setupMouseHandlers();
					createTimelineSlider();
					//createZoomSlider();
					createPlaybackSpeedSlider();
					setupSliderHandlers();
					setupUIHandlers();
					//initializeSnaplapseUI();
					//handlePluginVideoTagOverride();
				} else {
					org.gigapan.Util.log("Timelapse already loaded, so update it with new JSON.  gigapanUrl = ["+gigapanUrl+"] and JSON = ["+JSON.stringify(gigapanJSON)+"]");
					timelapse.changeDataset(gigapanUrl, gigapanJSON);
				}
				setViewportSize(gigapanJSON["video_width"] - gigapanJSON["tile_width"], gigapanJSON["video_height"] - gigapanJSON["tile_height"]);
			}

			function setupSliderHandlers() {
			  $(".ui-slider-handle").bind("mouseover mouseup", function() {
			    this.style.cursor = 'url("timelapse/css/cursors/openhand.cur") 10 10, move';
			  });

			  $(".ui-slider").bind({
			    slide: function() {
			      this.style.cursor = 'url("timelapse/css/cursors/closedhand.cur") 10 10, move';
			      $(".ui-slider-handle").bind("mousemove", function() {
			        this.style.cursor = 'url("timelapse/css/cursors/closedhand.cur") 10 10, move';
			      });
			    },
			    slidestop: function() {
			      $(".ui-slider-handle").bind("mousemove", function() {
			        this.style.cursor = 'url("timelapse/css/cursors/openhand.cur") 10 10, move';
			      });
			    },
			    mouseover: function() {
			      this.style.cursor = "pointer";
			    }
			  });
			}

			function isCurrentTimeAtOrPastDuration() {
			  // fix the numbers, but subtract 0 from each to convert back to float since toFixed gives a string
			  var num1Fixed = timelapseCurrentTimeInSeconds.toFixed(3) - 0;
			  var num2Fixed = timelapseDurationInSeconds.toFixed(3) - 0;
			  return num1Fixed >= num2Fixed;
			}

      function setupUIHandlers() {
        /*google.maps.event.addDomListener($("a#size").get(0), 'click', function() {
          $("li#sizeoptions").fadeIn(100);
        });

        google.maps.event.addDomListener($("li#sizeoptions a").get(0), 'click', function() {
          $("li#sizeoptions").hide();
          $("li#sizeoptions a").removeClass("current");
          $(this).addClass("current");
        });

        google.maps.event.addDomListener($(document).get(0), 'click', function(event) {
          if ($(event.target).closest("a#size").get(0) == null) {
            $("li#sizeoptions").hide();
          }
        });*/

        google.maps.event.addDomListener($("#mainbutton.play").get(0), 'click', function() {
          if ($(this).attr("class") == "play") {
            $(this).attr({"class": "pause", "title": "Pause"});
            timelapse.play();
            hideEeLayer();
            timelapseStayOn = true;
          } else {
            $(this).attr({"class": "play", "title": "Play"});
            timelapse.pause();
            //showTimelapseLayer();
            changeEeLayer();
          }
        });
      }

			function setViewportSize(newWidth, newHeight) {
				var bounds = timelapse.getBoundingBoxForCurrentView();

				$("#timelapse").css({"width": newWidth+"px", "height": newHeight+"px"});
				$("#controls").width(newWidth);
				$("#timelineSlider").width(newWidth-8); //subtract 8px (width of the slider handle)
				$("#spinnerOverlay").css({"top": newHeight/2-$("#spinner").height()/2+"px", "left": newWidth/2-$("#spinner").width()/2+"px"});
				$("#instructions").css({"height": newHeight+2+$("#filler").height()+"px"}); //not sure why there is a 2px offset...
				$(".layerSlider").css({"top": newHeight+2+$("#filler").height()+$("#controls").height()+"px", "right": "28px"}); //not sure why there is a 2px offset...

				timelapse.updateDimensions();
				timelapse.warpToBoundingBox(bounds);

				//var topPos = ((parseInt(jQuery("#map_canvas").css("height")))/2) - ((parseInt(jQuery("#player").css("height")))/2);
				//var leftPos = ((parseInt(jQuery("#map_canvas").css("width")))/2) - ((parseInt(jQuery("#player").css("width")))/2);
				//$('#player').css({"top":topPos, "left":leftPos});
			}

			function loadGigapanJSON() {
				// fetch the datasetId and then construct the URL used to get the JSON for the desired dataset
				var datasetId = gigapanDatasetsJSON["datasets"][datasetIndex]["id"];
				var tileHostUrlPrefix = getTileHostUrlPrefix() + datasetId + "/";
				var gigapanJSONHostUrlPrefix = (typeof gigapanDatasetsJSON["dataset-json-host-url-prefix"] != "undefined") ? gigapanDatasetsJSON["dataset-json-host-url-prefix"] + datasetId + "/" : tileHostUrlPrefix;
				var jsonUrl = gigapanJSONHostUrlPrefix + "r.json";

				org.gigapan.Util.log("Attempting to fetch gigapan JSON from URL [" + jsonUrl + "]...");
				$.ajax({
					dataType: "json",
					url: jsonUrl,
					success: function(gigapanJSON) {
						if (gigapanJSON && gigapanJSON["tile_height"]) {
							org.gigapan.Util.log("Loaded this JSON: [" + JSON.stringify(gigapanJSON) + "]");
							loadTimelapse(tileHostUrlPrefix, gigapanJSON);
						} else {
							org.gigapan.Util.error("Failed to load gigapan json from URL [" + jsonUrl + "]");
						}
					},
					error: function() {
						org.gigapan.Util.error("Error loading gigapan json from URL [" + jsonUrl + "]");
					}
				});
			}


			function getTileHostUrlPrefix() {
				// get the tile host URL prefixes from the JSON, or use a default if undefined
				var prefixes = ["http://g7.gigapan.org/alpha/timelapses/"];
				if (typeof gigapanDatasetsJSON["tile-host-url-prefixes"] != "undefined" && $.isArray(gigapanDatasetsJSON["tile-host-url-prefixes"]) && gigapanDatasetsJSON["tile-host-url-prefixes"].length > 0) {
					prefixes = gigapanDatasetsJSON["tile-host-url-prefixes"];
				}
				// now pick one at random
				//return prefixes[Math.floor(Math.random() * prefixes.length)];
				return prefixes;
			}

			function validateAndSetDatasetIndex(newDatasetIndex) {
				// make sure the datasetIndex is a valid number, and within the range of datasets for this gigapan.
				if (!org.gigapan.Util.isNumber(newDatasetIndex)) {
					datasetIndex = 0;
				} else {
					datasetIndex = Math.max(0, Math.min(newDatasetIndex, gigapanDatasetsJSON["datasets"].length - 1));
				}
			}

			function timelapseInitialize() {
				timelapseMetadataJSON = {};
				gigapanId = timelapseMetadataJSON["id"] || "MODIS_MCD43A4_L4_9800m";
				hasLayers = timelapseMetadataJSON["has_layers"] || false;
				if (hasLayers) $(".layerSlider").show();
				repeatVideo = timelapseMetadataJSON["repeat"]
				if (repeatVideo) $("#repeat").attr("class", "repeat active");
				org.gigapan.Util.log("id=["+gigapanId+"]");

				var host = timelapseMetadataJSON["host"] || "000";
				var hostPrefix = "/timemachines/" + gigapanId + "/";
				var jsonUrl = hostPrefix + gigapanId + ".json";
				var tileHostUrlPrefixes = ["http://tm"+host+".gigapan.org/timemachines/"+gigapanId+"/"];

				//SPECIFIC CODE TO RUN LOCALLY
				gigapanId = "MODIS_MCD43A4_L4_9800m"
				hostPrefix = "/timemachines/" + gigapanId + "/";
				jsonUrl = hostPrefix + gigapanId + ".json";
				tileHostUrlPrefixes = ["/timemachines/"+gigapanId+"/"];
				//END

				org.gigapan.Util.log("Attempting to fetch gigapan datasets JSON from URL [" + jsonUrl + "]...");
				$.ajax({
					dataType: "json",
					url: jsonUrl,
					success: function(json) {
						gigapanDatasetsJSON = json;
						if (gigapanDatasetsJSON && gigapanDatasetsJSON["base-id"] == gigapanId && gigapanDatasetsJSON["datasets"] && gigapanDatasetsJSON["datasets"].length > 0 && gigapanDatasetsJSON["sizes"] && gigapanDatasetsJSON["sizes"].length > 0) {
							gigapanDatasetsJSON["dataset-json-host-url-prefix"]=hostPrefix;
							gigapanDatasetsJSON["tile-host-url-prefixes"]=tileHostUrlPrefixes;

							org.gigapan.Util.log("Loaded this JSON: [" + JSON.stringify(gigapanDatasetsJSON) + "]");

							// set document title
							document.title = "GigaPan Time Machine: " + gigapanDatasetsJSON["name"];

							// populate the player size dropdown
							var html = "";
							var numSizes = gigapanDatasetsJSON["sizes"].length;
							for (var i = 0; i < numSizes; i++) {
								html += '<li><a id='+gigapanDatasetsJSON["sizes"][i]+' href="#" onclick="switchSize('+i+'); return false;"> '+gigapanDatasetsJSON["sizes"][i]+' </a></li>';
							}
							$("#sizechoices").append(html);

							// set the current view to the largest size
							var largestSize = $("#sizechoices li a").last();
							largestSize.addClass("current");
							$("#playerSizeText").text(largestSize.text());
							datasetIndex = timelapseMetadataJSON["dataset"] || gigapanDatasetsJSON["sizes"].length; //default to largest size (ie last in the list) if none is specified.
							org.gigapan.Util.log("datasetIndex=["+datasetIndex+"]");

							// make sure the datasetIndex is a valid number, and within the range of datasets for this gigapan.
							validateAndSetDatasetIndex(datasetIndex);

							// finally, load the gigapan
							loadGigapanJSON();

						} else {
							org.gigapan.Util.error("Failed to load gigapan datasets json from URL [" + jsonUrl + "]");
						}
					},
					error: function() {
						org.gigapan.Util.error("Error loading gigapan datasets json from URL [" + jsonUrl + "]");
					}
				});
		  }
		</script>
	</head>

	<body>
		<div id="player" style="position: absolute; left:0px; top:0px; visibility: hidden">
			<div id="spinnerOverlay"><img id="spinner" src="timelapse/images/loading.gif" width="32" height="32"></div>
			<div id="timelapse" style="position: relative; width:512px; height:288px; background:black; overflow:hidden; border: 1px solid black;"></div>
		</div>
	  <div id="map_canvas"></div>
		<div id="filler" style="width:inherit !important; min-width: 512px !important;">
		  <div id="timelineSlider" title="Click to go to a different point in time" style="width:99.4% !important; min-width: 512px !important"></div>
		</div>
		<div id="controls" style="width:100% !important; min-width: 512px !important; border: none">
			<a href="#" title="Play" class="play" id="mainbutton"></a>
			<a href="#" title="Stop time warp" class="stop" id="mainbutton" style="display: none;"></a>
			<a href="#" title="Repeat" class="inactive" id="repeat" style="visibility: hidden"></a>
			<ul id="sidebuttons" style="visibility: hidden">
				<li id="sizeoptions" style="display: none;">
					<ul id="sizechoices">
						<li>Player Size</li>
					</ul>
				</li>
				<li>
					<a href="#" title="Player size" id="size" onclick="return false;">
						<div id="playerSizeText"></div>
					</a>
				</li>
				<li>
					<a href="#" title="Instructions" id="help" class="enabled" onclick="return false;">
						<div id="helpText">Help</div>
					</a>
				</li>
			</ul>
			<div id="videoTime"><b><span id="currentTime">00:00.00</span>/<span id="totalTime">00:00.00</span></b></div>
			<div id="captureTime"><span id="currentCaptureTime"></span></div>
			<div id="playBackSpeedSlider">
				<select name="speed" id="speed">
					<option value="-1">Backward, Full Speed</option>
					<option value="-.5">Backward, Half Speed</option>
					<option value=".5">Forward, Half Speed</option>
					<option value="1" selected="selected">Forward, Full Speed</option>
				</select>
			</div>
		</div>
	</body>
</html>
