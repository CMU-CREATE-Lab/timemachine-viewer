<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

    <link href="../css/snaplapse.css" rel="stylesheet" type="text/css"/>
    <link href="../css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css"/>
    <link href="../css/defaultUI.css" rel="stylesheet" type="text/css"/>
    <link href="../css/visualizer.css" rel="stylesheet" type="text/css"/>
    <link href="../css/annotator.css" rel="stylesheet" type="text/css"/>
    <link href="../libs/change-detect/css/change.css" media="screen" rel="stylesheet" type="text/css" />

    <script src="../js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="../js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="../js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
    <script src="../js/kinetic/kinetic.min.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/util.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
    <script src="../js/Math.uuid.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/mercator.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/visualizer.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/annotator.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/urlEncoder.js" type="text/javascript"></script>

    <script src="../js/org/gigapan/postmessage.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/crossdomain_api.js" type="text/javascript"></script>

    <script src="https://www.google.com/jsapi" type="text/javascript"></script>
    <script src="../libs/change-detect/js/ThumbnailServiceAPI.js" type="text/javascript"></script>
    <script src="../libs/change-detect/js/TimeMachineCanvasLayer.js" type="text/javascript"></script>
    <script src="../libs/change-detect/js/ThumbnailTool.js" type="text/javascript"></script>

    <script src="../template_includes.js" type="text/javascript"></script>

    <style>
      #timeMachine {
        position: relative;
        margin-top: 10px;
        margin-left: 10px;
        width: 843px;
        height: 702px;
      }
      #chart {
        margin-left: 11px;
        width: 839px;
        height: 170px;
      }
      #poi {
        margin-left: 10px;
        width: 843px;
      }
    </style>

    <script type="text/javascript">
      jQuery.support.cors = true;

      var url = "http://timemachine1.gc.cs.cmu.edu/timemachines/breathecam/timemachines/heinz/2014-05-26.timemachine";
      var timelapse;
      var thumbnailTool;
      var chart;
      var currentThumbnail = new ThumbnailServiceAPI({
        host: "http://staging.timemachine-api.cmucreatelab.org/thumbnail"
      }, {
        format: "png"
      });

      google.load("visualization", "1", {
        packages: ["corechart"]
      });

      document.addEventListener('DOMContentLoaded', function() {
        init();
        sticky("chart", 550);
      }, false);

      window.addEventListener('resize', function() {
        sticky("chart", 550);
      }, false);

      function init() {
        var viewerOptions = {
          url: url,
          disableTourLooping: true,
          enableEditor: true,
          enablePresentationSlider: true,
          enableAnnotator: true,
          showFullScreenBtn: false,
          showLogoOnDefaultUI: false,
          mediaType: ".mp4",
          datasetType: "breathecam",
          fps: 11.9,
          onTimeMachinePlayerReady: function(viewerDivId) {
            timelapse.seekToFrame(timelapse.getNumFrames() - 60);
            var view = timelapse.getView();
            var scaleOffset = 40 / view.scale;
            var thumbnailToolOptions = {
              ltrb: (view.x - scaleOffset) + "," + (view.y - scaleOffset) + "," + (view.x + scaleOffset) + "," + (view.y + scaleOffset),
              doFilter: true
            };
            thumbnailTool = new ThumbnailTool(timelapse, thumbnailToolOptions);
          }
        };
        timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", viewerOptions);
        var oGetShareView = timelapse.getShareView;
        timelapse.getShareView = function() {
          var shareStr = oGetShareView();
          shareStr += "&url=" + url;
          if (thumbnailTool.display) {
            shareStr += '&ttLTRB=' + thumbnailTool.bounds_.xmin + ',' + thumbnailTool.bounds_.ymin + ',' + thumbnailTool.bounds_.xmax + ',' + thumbnailTool.bounds_.ymax;
          }
          return shareStr;
        }
        var el = document.getElementById('show-current-thumbnail');
        el.addEventListener("click", function(event) {
          event.target.href = thumbnailTool.getCurrentThumbnail();
          return false;
        })
        var el = document.getElementById('show-current-gif');
        el.addEventListener("click", function(event) {
          event.target.href = thumbnailTool.getCurrentGif();
          return false;
        })
      }

      function resetFilter() {
        var view = thumbnailTool.timelapse_.getView();
        var scaleOffsetX = 40 / view.scale;
        var scaleOffsetY = 40 / view.scale;
        var bounds = {
          xmin: view.x - scaleOffsetX,
          xmax: view.x + scaleOffsetX,
          ymin: view.y - scaleOffsetY,
          ymax: view.y + scaleOffsetY
        };
        thumbnailTool.setBounds(bounds);
        thumbnailTool.draw();
        var filterCallBack = function(r) {
          var o = JSON.parse(r);
          drawResults(o.values);
        };
        thumbnailTool.filter(filterCallBack);
      }

      function getCurrentThumbnail() {
        var bb = timelapse.getBoundingBoxForCurrentView();
        currentThumbnail.root = timelapse.getSettings().url, currentThumbnail.tileFormat = timelapase.getSettings().mediaType.slice(1), currentThumbnail.boundsLTRB = bb.xmin + "," + bb.ymin + "," + bb.xmax + "," + bb.ymax;
        currentThumbnail.width = bb.xmax - bb.xmin;
        currentThumbnail.height = bb.ymax - bb.ymin;
        currentThumbnail.frameTime = timelapse.getCurrentFrame() / timelapse.getFps();
      }

      // FIXME: position: sticky
      function sticky(id, height) {
        var el = document.getElementById(id);
        if (window.innerHeight < height) {
          el.style['-webkit-transform'] = "translateY(" + (window.innerHeight - height) + "px)";
          el.style['transform'] = "translateY(" + (window.innerHeight - height) + "px)";
        } else {
          el.style['-webkit-transform'] = "";
          el.style['transform'] = "";
        }
      }
    </script>
  </head>
  <body>
    <div id="timeMachine"></div>
    <div id="thumbnail-tool">
      Thumbnail Tool
    </div>
    <div id="poi">
      <a href="javascript:void(0)" onclick="resetFilter()">Click here</a> to recenter rectangle on screen. &nbsp;|&nbsp; <a href="#" target="_blank" id="show-current-thumbnail">Click here</a> for thumbnail of rectangle. &nbsp;|&nbsp; <a href="#" target="_blank" id="show-current-gif">Click here</a> for animated gif of rectangle.
    </div>
    <div id="chart" class='ajax-loader'></div>
  </body>
</html>