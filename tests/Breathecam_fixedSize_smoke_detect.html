<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

    <link href="../css/snaplapse.css" rel="stylesheet" type="text/css"/>
    <link href="../css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css"/>
    <link href="../css/defaultUI.css" rel="stylesheet" type="text/css"/>
    <link href="../css/visualizer.css" rel="stylesheet" type="text/css"/>
    <link href="../css/annotator.css" rel="stylesheet" type="text/css"/>
    <link href="../libs/change-detect/css/change.css" media="screen" rel="stylesheet" type="text/css"/>

    <script src="../js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="../js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="../js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
    <script src="../js/kinetic/kinetic.min.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/util.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
    <script src="../js/Math.uuid.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/mercator.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/visualizer.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/annotator.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/urlEncoder.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/timelineMetadataVisualizer.js" type="text/javascript"></script>

    <script src="../js/org/gigapan/postmessage.js" type="text/javascript"></script>
    <script src="../js/org/gigapan/timelapse/crossdomain_api.js" type="text/javascript"></script>

    <script src="../libs/change-detect/js/ThumbnailServiceAPI.js" type="text/javascript"></script>
    <script src="../libs/change-detect/js/TimeMachineCanvasLayer.js" type="text/javascript"></script>
    <script src="../libs/change-detect/js/ThumbnailTool.js" type="text/javascript"></script>
    <script src="../libs/change-detect/js/BoxEventHandler.js" type="text/javascript"></script>
    <script src="../libs/change-detect/js/ChangeDetectionTool.js" type="text/javascript"></script>
    <script src="../libs/change-detect/js/canvasjs.min.js" type="text/javascript"></script>

    <script src="../template_includes.js" type="text/javascript"></script>
    <script src="smoke.js" type="text/javascript"></script>

    <style>
      /*#timeMachine {
        position: relative;
        margin-top: 10px;
        margin-left: 10px;
        width: 900px;
        height: 700px;
      }*/
      #timeMachine {
        width: 100%;
        height: 100%;
      }
      #fast-forward-start {
        position: absolute;
        bottom: 10px;
        left: 12px;
        z-index: 9999;
      }
      #fast-forward-stop {
        position: absolute;
        bottom: 10px;
        left: 155px;
        z-index: 9999;
      }
      /*#chart {
        position: absolute;
        top: 500px;
        margin-left: 11px;
        width: 839px;
        height: 210px;
        z-index: 1;
      }*/
    </style>

    <script type="text/javascript">
      jQuery.support.cors = true;

      var url = "http://tiles.cmucreatelab.org/ecam/timemachines/shenango1/2015-05-02.timemachine";
      var timelapse;

      function init() {
        var viewerOptions = {
          url: url,
          showFullScreenBtn: false,
          enableEditor: true,
          enablePresentationSlider: true,
          enableAnnotator: true,
          enableTimelineMetadataVisualizer: true,
          startEditorFromPresentationMode: true,
          mediaType: ".mp4",
          showThumbnailTool: true,
          showChangeDetectionOnLoad: true,
          onTimeMachinePlayerReady: function(viewerDivId) {
            setupPostMessageHandlers();
            initFastforward();
          },
          disableTourLooping: true,
          datasetType: "breathecam",
          enableChangeDetection: true
        };
        timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", viewerOptions);
      }

      var idxSeg;
      var $playbackButton;
      var $timelineSlider;
      var $timelineSliderFiller;

      var initFastforward = function() {
        timelapse.setNewView({x: 2585.5560361492453, y: 1406.6228732376014, scale: 0.5818041565461248}, true);
        timelapse.getChangeDetectionTool().hideFilterBound();
        timelapse.getChangeDetectionTool().drawResults(smoke_detection.values);
        $("#" + timelapse.getViewerDivId() + " .tool").hide();
        $playbackButton = $("#" + timelapse.getViewerDivId() + " .playbackButton");
        $timelineSlider = $("#" + timelapse.getViewerDivId() + " .timelineSlider");
        $timelineSliderFiller = $("#" + timelapse.getViewerDivId() + " .timelineSliderFiller");
        $("#fast-forward-start").on("click", function() {
          idxSeg = getClosestSegIdx();
          timelapse.seekToFrame(frames_start[idxSeg]);
          setFastforwardUI("start");
          timelapse.play();
          timelapse.addTimeChangeListener(timeChangeListener);
        });
        $("#fast-forward-stop").on("click", function() {
          timelapse.removeTimeChangeListener(timeChangeListener);
          timelapse.pause();
          setFastforwardUI("stop");
        });
      };

      var getClosestSegIdx = function() {
        // needle in a haystack problem
        var needle = timelapse.getCurrentFrameNumber();
        var haystack = [];
        var haystack_idx = [];
        for (var i = 0; i < frames_start.length; i++) {
          haystack[i] = Math.abs(frames_start[i] - needle);
          haystack_idx[i] = i;
        }
        // sort the indices using a compare function
        haystack_idx = haystack_idx.sort(function (a, b) {
          return haystack[a] < haystack[b] ? -1 : (haystack[a] > haystack[b] ? 1 : 0);
        });
        // return the first sorted indices
        return haystack_idx[0];
      };

      var timeChangeListener = function() {
        var currentFrame = timelapse.getCurrentFrameNumber();
        if (currentFrame < frames_start[idxSeg]) {
          timelapse.seekToFrame(frames_start[idxSeg]);
        }
        if (currentFrame > frames_end[idxSeg]) {
          if(idxSeg < frames_start.length - 1) {
            idxSeg++;
          } else {
            timelapse.pause();
            timelapse.removeTimeChangeListener(timeChangeListener);
            setFastforwardUI("stop");
          }
        }
      };

      var setFastforwardUI = function(state) {
        if (state == "start") {
          $playbackButton.button("option", "disabled", true);
          $timelineSlider.slider("option", "disabled", true);
          $timelineSliderFiller.css("opacity", "0.5");
          $("#fast-forward-start").prop("disabled", true);
          $("#fast-forward-stop").prop("disabled", false);
        } else if (state == "stop") {
          $playbackButton.button("option", "disabled", false);
          $timelineSlider.slider("option", "disabled", false);
          $timelineSliderFiller.css("opacity", "1");
          $("#fast-forward-start").prop("disabled", false);
          $("#fast-forward-stop").prop("disabled", true);
        }
      };

      $(init);
    </script>
  </head>
  <body>
    <div id="timeMachine"></div>
    <button id="fast-forward-start">Start Fast-forwarding</button>
    <button id="fast-forward-stop" disabled>Stop Fast-forwarding</button>
  </body>
</html>