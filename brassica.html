<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<title>GigaPan Timelapse Explorer</title>
<script src="js/jquery/jquery.min.js" type="text/javascript"></script>
<script src="js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
<script src="js/jquery/plugins/mouse/jQuery_mousewheel_plugin.js" type="text/javascript"></script>
<script src="js/jquery/plugins/slider/selectToUISlider.jQuery.js" type="text/javascript"></script>
<script src="js/org/gigapan/util.js" type="text/javascript"></script>
<script src="js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
<script src="js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
<script src="js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>

<link href="css/timelapse.css" rel="stylesheet" type="text/css"/>
<link href="css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css"/>
<link href="css/ui.slider.extras.css" rel="stylesheet" type="text/css"/>
<style type="text/css">
   .snaplapse_keyframe_list_item {
      height:50px;
      display: block;
      padding: 1px;
      margin: 0;
      cursor: pointer;
      border:solid 1px black;
      background-color:white;
   }

   #snaplapse_keyframe_list .ui-selecting { background: #ddddff; }
	#snaplapse_keyframe_list .ui-selected { background: #eeeeff; color: black; }
</style>
<script type="text/javascript">
   var timelapseDurationInSeconds = 0.0;
   var timeStepInSecs = 0.04; // 25 frames per second
   var timelapse = null;
   var timelapseCurrentTimeInSeconds = 0.0;
   var snaplapse = null;
   var saveSnaplapseWindow = null;
   var loadSnaplapseWindow = null;

   $(document).ready(function()
      {

		 if (!browserSupported()){
			window.location = "browsernotsupported.html";
		 }


         // Remote testing with Safari
         timelapse = new org.gigapan.timelapse.Timelapse(
                                                         'http://timelapse.gigapan.org/alpha/timelapses/brassica1-15m-halfsize/',
                                                         'timelapse',
                                                         {"tile_height":256,"height":3876,"fps":25,"frames":2438,"width":9856,"tile_width":256}
                                                        );

         // Remote testing with Chrome
         //timelapse = new org.gigapan.timelapse.Timelapse(
         //                                                'http://timelapse.gigapan.org/alpha/timelapses/brassica1-15m-halfsize-nb/',
         //                                                'timelapse',
         //                                                {"tile_height":256,"height":3876,"fps":25,"frames":2438,"width":9856,"tile_width":256}
         //                                               );

         // Local testing
         //timelapse = new org.gigapan.timelapse.Timelapse(
         //                                                '../timelapses/brassica1-15m-halfsize/',
         //                                                'timelapse',
         //                                                {"tile_height":256,"height":3876,"fps":25,"frames":2438,"width":9856,"tile_width":256}
         //                                               );

         timelapse.addTimeChangeListener(function(t)
                                            {
                                            timelapseCurrentTimeInSeconds = t;
                                            if (timelapseCurrentTimeInSeconds < 0) {
                                              timelapseCurrentTimeInSeconds = 0;
                                              $('#play_toggle').attr("class", "play_mouseout");
                                              $('#play_toggle').attr("title", "Play");
                                            }
                                            $("#currentTime").text(org.gigapan.Util.formatTime(timelapseCurrentTimeInSeconds));
                                            $("#timelineSlider")['slider']("option", "value", timelapseCurrentTimeInSeconds);
                                            if (timelapseCurrentTimeInSeconds >= timelapseDurationInSeconds)
                                               {
                                               $('#play_toggle').attr("class", "play_mouseout");
                                               $('#play_toggle').attr("title", "Play");
                                               }
                                            });

         $(this)['keydown'](timelapse.handleKeydownEvent);
         $(this)['keyup'](timelapse.handleKeyupEvent);
         $("#timelapse").mousewheel(timelapse.handleMousescrollEvent);

         window.onunload = timelapse.handleWindowClose;

         timelapseDurationInSeconds = timelapse.getNumFrames() / timelapse.getFps();

         $("#timelineSlider")['slider']({
                                        animate: true,
                                        value: 0,
                                        min: 0,
                                        max: timelapseDurationInSeconds,
                                        range: "min",
                                        step: timeStepInSecs,
                                        slide: function(e, ui)
                                           {
                                           timelapseCurrentTimeInSeconds = ui.value;
                                           var timeInSecs = ui.value;
                                           timelapse.seek(timeInSecs);
                                           }
                                        });

		 $('#speed').selectToUISlider({
			labels: 12,
			labelSrc: "text",
			tooltipSrc: "text"
		 }).hide();

		 $("#slider-vertical").slider({
			orientation: "vertical",
			min: timelapse.getMinScale(),
			max: timelapse.getMaxScale(),
			step: .01,

		 slide: function(e, ui)
			{
               timelapse.setScale(ui.value);
   			}
		 });

         $('.ui-slider-handle').bind("mouseover", function() {
            $('.ui-slider-handle').css("cursor", "url('css/cursors/openhand.cur')");
         });

         $('.ui-slider').bind("slide", function() {
            $('.ui-slider-handle').css("cursor", "url('css/cursors/closedhand.cur')");
         });

         $('.ui-slider').bind("slidestop", function() {
            $('.ui-slider-handle').css("cursor", "url('css/cursors/openhand.cur')");
         });

         $('.ui-slider').bind("mouseover", function() {
            $(this).css("cursor", "pointer");
         });

         $('#play_toggle').bind("mousemove", function() {
            if ($(this).attr("class") == "play_mouseout") $(this).attr("class", "play_mouseover");
            else if ($(this).attr("class") == "pause_mouseout") $(this).attr("class", "pause_mouseover");
         });

         $('#play_toggle').bind("mouseout", function() {
            if ($(this).attr("class") == "play_mouseover") $(this).attr("class", "play_mouseout");
            else if ($(this).attr("class") == "pause_mouseover") $(this).attr("class", "pause_mouseout");
         });

         $('#play_toggle').bind("click", function()
            {
            if ($(this).attr("class") == "play_mouseover")
               {
               $(this).attr("class", "pause_mouseout");
               $(this).attr("title", "Pause");
               if (timelapseCurrentTimeInSeconds >= timelapseDurationInSeconds)
                  {
                  $("#timelineSlider")['slider']("option", "value", 0);
                  timelapse.seek(0);
                  }
               timelapse.play();
               }
            else
               {
               $(this).attr("class", "play_mouseout");
               $(this).attr("title", "Play");
               timelapse.pause();
               }
         });

         $('#home').bind("mousemove", function() {
            $(this).attr("title", "Home");
            $(this).css("cursor", "pointer");
         });

         $('#home').bind("click", function() {
               timelapse.warpTo(timelapse.homeView());
         });

         $('#zoom_in').bind("click", function() {
         	  val = $("#slider-vertical")['slider']("option", "value") + .01;
              $("#slider-vertical")['slider']("option", "value", val);
         	  timelapse.setScale(val);
         });

         $('#zoom_in').bind("mousemove", function() {
            $(this).attr("title", "Zoom In");
            $(this).css("cursor", "pointer");
         });

         $('#zoom_out').bind("click", function() {
         	  val = $("#slider-vertical")['slider']("option", "value") - .01;
         	  $("#slider-vertical")['slider']("option", "value", val);
         	  timelapse.setScale(val);
         });

         $('#zoom_out').bind("mousemove", function() {
            $(this).attr("title", "Zoom Out");
            $(this).css("cursor", "pointer");
         });

         $('#up').bind("mousemove", function() {
            $(this).attr("title", "Move Up");
            $(this).css("cursor", "pointer");
         });

         $('#up').bind("click", function() {
            timelapse.movePos("up");
         });

         $('#down').bind("mousemove", function() {
            $(this).attr("title", "Move Down");
            $(this).css("cursor", "pointer");
         });

         $('#down').bind("click", function() {
            timelapse.movePos("down");
         });

         $('#right').bind("mousemove", function() {
            $(this).attr("title", "Move Right");
            $(this).css("cursor", "pointer");
         });

         $('#right').bind("click", function() {
            timelapse.movePos("right");
         });

         $('#left').bind("mousemove", function() {
            $(this).attr("title", "Move Left");
            $(this).css("cursor", "pointer");
         });

         $('#left').bind("click", function() {
            timelapse.movePos("left");
         });

         $("#totalTime").text(org.gigapan.Util.formatTime(timelapseDurationInSeconds));

         $("#snaplapse_keyframe_list")['selectable']({
                                                        selected: handleSnaplapseFrameSelectionChange,
                                                        unselected: handleSnaplapseFrameSelectionChange
                                                     });

		 $("#slider-vertical")['slider']("option", "value", timelapse.getDefaultScale());

      });

   function browserSupported() {
     var v = document.createElement('video');
     return !!(v.canPlayType && v.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').replace(/no/, ''));
   }

   function changeTimelapse(timelapse) {
      alert("TODO - changing timelapse to: " + timelapse);
   }

   function handleSnaplapseFrameSelectionChange(event, ui)
      {
      var numSelected = $("#snaplapse_keyframe_list > .ui-selected").size();
      $("#numSnaplapseKeyframesSelected").text(numSelected);
      }

   function newSnaplapse(json)
      {
      snaplapse = new org.gigapan.timelapse.Snaplapse(timelapse);
      snaplapse.addEventListener('play',
                                 function()
                                    {
                                       $("#newSnaplapseButton").attr("disabled", "disabled");
                                       $("#recordKeyframeButton").attr("disabled", "disabled");
                                       $("#playStopSnaplapseButton").text("Stop Snaplapse");
                                    });
      snaplapse.addEventListener('stop',
                                 function()
                                    {
                                       $("#newSnaplapseButton").removeAttr("disabled");
                                       $("#recordKeyframeButton").removeAttr("disabled");
                                       $("#playStopSnaplapseButton").text("Play Snaplapse");
                                    });
      snaplapse.addEventListener('record-keyframe',
                                 function(frame)
                                    {
                                       var numKeyframes = snaplapse.getNumKeyframes();
                                       $("#numSnaplapseKeyframes").text(numKeyframes);
                                       if (numKeyframes > 1)
                                          {
                                          $("#playStopSnaplapseButton").removeAttr("disabled");
                                          $("#saveSnaplapseButton").removeAttr("disabled");
                                          }
                                       var keyframeListItem = document.createElement("div");
                                       keyframeListItem.id = "snaplapse_keyframe_" + numKeyframes;
                                       $("#snaplapse_keyframe_list").append(keyframeListItem);
                                       $("#" + keyframeListItem.id).html("Keyframe " + numKeyframes + "<br>Time: " + frame['time']).addClass("snaplapse_keyframe_list_item");
                                    });
      $("#recordKeyframeButton").removeAttr("disabled");
      $("#playStopSnaplapseButton").attr("disabled", "disabled");
      $("#saveSnaplapseButton").attr("disabled", "disabled");
      $("#numSnaplapseKeyframes").text("0");
      $("#snaplapse_keyframe_list").empty();
      if (saveSnaplapseWindow)
         {
         saveSnaplapseWindow.close();
         }

      if (typeof json != 'undefined' && json != null)
         {
         return snaplapse.loadFromJSON(json);
         }

      return true;
      }

   function recordKeyframe()
      {
      if (snaplapse)
         {
         var success = snaplapse.recordKeyframe();
         if (!success)
            {
               alert("ERROR: Invalid time position\n\n" +
                     "The flow of time in a snaplapse can only be in one\n" +
                     "direction, and the time position of a keyframe cannot\n" +
                     "be the same as the previous keyframe.")
            }
         }
      }

   function playStopSnaplapse()
      {
      if (snaplapse.isPlaying())
         {
         snaplapse.stop();
         }
      else
         {
         snaplapse.play();
         }
      }

   function saveSnaplapse()
      {
      if (snaplapse && (snaplapse.getNumKeyframes() > 1))
         {
         // open a new window--that new window will call this window's getSnaplapseJSON() function to dynamically write
         // the stringified JSON to itself.  We can't simply have this window write to the new one immediately after
         // opening because we need to wait for the DOM to load.  So, rather than have some timeout lameness, it's easier
         // for the new window to just request the JSON when it's ready for it.
         saveSnaplapseWindow = popup('save_snaplapse.html', 'saveSnaplapseWindow');
         }
      else
         {
         alert("ERROR: No snaplapse to save--please create a snaplapse and add at least once keyframe to it.")
         }
      }

   function getSnaplapseJSON()
      {
      return snaplapse.getAsJSON();
      }

   function showLoadSnaplapseWindow()
      {
      loadSnaplapseWindow = popup('load_snaplapse.html', 'loadSnaplapseWindow');
      }

   function loadSnaplapse(json)
      {
      if (loadSnaplapseWindow)
         {
         if (newSnaplapse(json))
            {
            loadSnaplapseWindow.close();
            }
         else
            {
            alert("ERROR: Invalid snaplapse file.");
            }
         }
      }

   // Code from:
   //    http://javascript-array.com/scripts/window_open/
   //    http://www.webdeveloper.com/forum/showthread.php?t=15735
   function popup(url, windowName)
      {
      // get dimensions of parent window so we can center the new window within the parent
      var parentWidth = $(window).width();
      var parentHeight = $(window).height();
      var parentX = (document.all) ? window.screenLeft : window['screenX'];
      var parentY = (document.all) ? window.screenTop : window['screenY'];

      var width = 400;
      var height = 460;
      var left = parentX + (parentWidth - width) / 2;
      var top = parentY + (parentHeight - height) / 2;
      var params = 'width=' + width + ', height=' + height;
      params += ', top=' + top + ', left=' + left;
      params += ', directories=no';
      params += ', location=no';
      params += ', menubar=no';
      params += ', resizable=yes';
      params += ', scrollbars=auto';
      params += ', status=no';
      params += ', toolbar=no';
      var newWindow = window.open(url, windowName, params);
      if (window.focus)
         {
         newWindow.focus()
         }
      return newWindow;
      }
</script>
</head>
<body onselectstart="return false">

<div style="width:800px; height:450px" style="position: relative;">

   <div class="overlay1">
      <div id="movement" style="margin:0px 0px 0px 0px"><img src="images/move.png" alt="zoom_in" /></div>
	  <div id="zoom_in" style="margin:2px 0px 0px 10px"><img src="images/plus.png" alt="zoom_in" /></div>
      <div id="slider-vertical" style="margin:0px 0px 0px 19px"></div>
      <div id="zoom_out" style="margin:0px 0px 0px 10px"><img src="images/minus.png" alt="zoom_in" /></div>
      <div id="home" style="margin:5px 0px 0px 10px"><img src="images/home.png" alt="home" /></div>
   </div>

   <div class="overlay2">
      <div id="up" style="margin:10px 0px 0px 16px"><img src="images/up.png" alt="move up" /></div>
	  <div id="down" style="margin:14px 0px 0px 16px"><img src="images/down.png" alt="move down" /></div>
	  <div id="right" style="margin:-16px 0px 0px 28px"><img src="images/right.png" alt="move right" /></div>
	  <div id="left" style="margin:-10px 0px 0px 10px"><img src="images/left.png" alt="move left" /></div>
   </div>

   <div id="timelapse" style="position: absolute; width:800px; height:450px; background:black; overflow:hidden"></div>
</div>

<table style="border: 2px solid black;">
   <tr>
      <td>
         <div id="home" class="home_mouseout" title="Home"></div>
      </td>
      <td>
         <div id="play_toggle" class="play_mouseout" title="Play"></div>
      </td>

      <td colspan="3">
         <div id="timelineSlider"></div>
      </td>
      <td align="right">
         <span id="currentTime">00:00:00</span>/<span id="totalTime">00:00:00</span><br/>
      </td>
   </tr>
</table>
<br/>
<table>
   <tr>
      <td>
         <label for="playBackSpeedSlider">Playback Speed:</label>
         <div id="playBackSpeedSlider" name="playBackSpeedSlider">
            <select name="speed" id="speed">
               <option value="-1">-1x</option>
               <option value="-.5">-½x</option>
               <option value="-.25">-¼x</option>
               <option value=".25">¼x</option>
               <option value=".5">½x</option>
               <option value="1" selected="selected">1x</option>
            </select>
         </div>
      </td>
   </tr>
</table>
<br/><br/>

<!--
<label for="timelapseChooser">Choose a timelapse:</label>
<select id="timelapseChooser" onchange="changeTimelapse(this.value);">
   <option value="brassica" selected="selected">Brassica
</select>
-->

<br/>Debug:
<input id="logVideoStatus" type="checkbox" onclick="timelapse.setStatusLoggingEnabled(this.value)"/><label for="logVideoStatus">Log video status</label>
<input id="showNativeVideoControls" type="checkbox" onclick="timelapse.setNativeVideoControlsEnabled(this.value)"/><label for="showNativeVideoControls">Show Native Video Controls</label>

<table border="0" cellpadding="3" cellspacing="0" class="control_panel" style="margin-top:10px">
   <tr>
      <th align="center">Snaplapse Composer</th>
   </tr>
   <tr>
      <td align="center">
         <button type="button" id="newSnaplapseButton" onclick="newSnaplapse(null)">New Snaplapse</button>
         <button type="button" disabled="disabled" id="recordKeyframeButton" onclick="recordKeyframe()">Record Keyframe</button>
         <button type="button" disabled="disabled" id="playStopSnaplapseButton" onclick="playStopSnaplapse()">Play Snaplapse</button>
         <button type="button" disabled="disabled" id="saveSnaplapseButton" onclick="saveSnaplapse()">Save Snaplapse</button>
         <button type="button" id="loadSnaplapseButton" onclick="showLoadSnaplapseWindow()">Load Snaplapse</button>
      </td>
   </tr>
   <tr>
      <td align="center">
         <table border="0" cellpadding="3" cellspacing="0" width="500">
            <tr>
               <td><label for="numSnaplapseKeyframes">Keyframes:</label> <span id="numSnaplapseKeyframes">0</span></td>
               <td align="right"><label for="numSnaplapseKeyframesSelected">Selected:</label> <span id="numSnaplapseKeyframesSelected">0</span></td>
            </tr>
         </table>
         <div id="snaplapse_keyframe_container" style="width:500px; height:300px; display:block; padding:0; margin:0; overflow:auto; border:solid 1px black; background-color:#eeeeee;">
            <div id="snaplapse_keyframe_list"></div>
         </div>
      </td>
   </tr>
</table>
</body>
</html>
